<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üå§ Weather + AI Assistant</title>
  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: linear-gradient(135deg, #74ebd5, #acb6e5);
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    h1 {
      margin-top: 30px;
      color: #fff;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
    }

    .container {
      background: white;
      border-radius: 15px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      width: 90%;
      max-width: 800px;
      padding: 25px;
      margin: 20px;
    }

    input[type="text"] {
      width: 75%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
    }

    button {
      padding: 10px 15px;
      border: none;
      border-radius: 8px;
      background-color: #4a90e2;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    button:hover {
      background-color: #357ab8;
    }

    .output {
      margin-top: 20px;
      background-color: #f3f7fd;
      border-radius: 10px;
      padding: 15px;
    }

    #map {
      width: 100%;
      height: 350px;
      border-radius: 12px;
      margin-top: 20px;
    }

    .ai-section {
      margin-top: 20px;
      padding: 15px;
      background: #fff4f4;
      border-radius: 10px;
      border-left: 5px solid #ff7b7b;
    }

    textarea {
      width: 100%;
      height: 80px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
      padding: 10px;
    }
  </style>
</head>
<body>
  <h1>üå§ Weather + AI Assistant</h1>
  <div class="container">
    <input type="text" id="city" placeholder="Enter city name" />
    <button onclick="getWeather()">Get Weather</button>
    
    <div class="output" id="weatherOutput"></div>
    <div id="map"></div>

    <div class="ai-section">
      <h3>üß† Ask AI Anything:</h3>
      <textarea id="userQuestion" placeholder="e.g. What clothes should I wear today?"></textarea><br>
      <button onclick="askAI()">Ask Gemini</button>
      <div class="output" id="aiOutput"></div>
    </div>
  </div>

  <script>
    let map;
    let userLat, userLon;

    // ‚úÖ Auto-center to user's location
    function initMap(lat, lon) {
      const mapDiv = document.getElementById('map');
      mapDiv.innerHTML = `<iframe
        width="100%"
        height="350"
        style="border:0"
        loading="lazy"
        allowfullscreen
        referrerpolicy="no-referrer-when-downgrade"
        src="https://www.google.com/maps?q=${lat},${lon}&z=10&output=embed">
      </iframe>`;
    }

    // ‚úÖ Get user's current location
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        userLat = pos.coords.latitude;
        userLon = pos.coords.longitude;
        initMap(userLat, userLon);
      },
      (err) => {
        console.warn("Location blocked. Showing default map.");
        initMap(19.076, 72.8777); // Default: Mumbai
      }
    );

    // ‚úÖ Fetch weather from Flask
    async function getWeather() {
      const city = document.getElementById("city").value.trim();
      if (!city) return alert("Please enter a city name!");

      const res = await fetch("/weather", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ city }),
      });

      const data = await res.json();
      if (data.error) {
        document.getElementById("weatherOutput").innerHTML = `<b>Error:</b> ${data.error}`;
        return;
      }

      const temp = data.main.temp;
      const desc = data.weather[0].description;
      const lat = data.coord.lat;
      const lon = data.coord.lon;

      document.getElementById("weatherOutput").innerHTML = `
        <h3>üìç ${city}</h3>
        <p>üå° Temperature: <b>${temp}¬∞C</b></p>
        <p>‚òÅÔ∏è Condition: <b>${desc}</b></p>
      `;

      initMap(lat, lon);
    }

    // ‚úÖ Ask Gemini AI
    async function askAI() {
      const question = document.getElementById("userQuestion").value.trim();
      if (!question) return alert("Please ask a question!");

      const res = await fetch("/assistant_ai", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question }),
      });

      const data = await res.json();
      document.getElementById("aiOutput").innerHTML =
        data.answer ? `<b>ü§ñ Gemini:</b> ${data.answer}` : `<b>Error:</b> ${data.error}`;
    }
  </script>
</body>
</html>